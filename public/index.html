<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Camp Together - Plan Your Next Adventure</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --forest-green: #2d5a3d;
        --sage-green: #87a878;
        --warm-brown: #8b6f47;
        --sunset-orange: #ff6b35;
        --cream: #fef9ef;
        --dark-text: #2c3e50;
        --light-gray: #f8f9fa;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: var(--dark-text);
        background-color: var(--cream);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* Hero Section */
      .hero {
        background: linear-gradient(
          135deg,
          rgba(45, 90, 61, 0.9),
          rgba(255, 107, 53, 0.8)
        );
        color: white;
        padding: 80px 0;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .hero::before {
        content: "üèïÔ∏è";
        position: absolute;
        font-size: 300px;
        opacity: 0.1;
        top: -50px;
        right: -50px;
        transform: rotate(-15deg);
      }

      .hero h1 {
        font-size: 3.5em;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        animation: fadeInUp 1s ease-out;
      }

      .hero-quote {
        font-size: 1.4em;
        font-style: italic;
        margin-bottom: 30px;
        opacity: 0.95;
        animation: fadeInUp 1s ease-out 0.3s both;
      }

      .activities {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-top: 40px;
        animation: fadeInUp 1s ease-out 0.6s both;
      }

      .activity-badge {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        padding: 10px 20px;
        border-radius: 25px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }

      .activity-badge:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      /* Section Styles */
      .section {
        padding: 60px 0;
        animation: fadeIn 0.8s ease-out;
      }

      .section-title {
        text-align: center;
        font-size: 2.5em;
        color: var(--forest-green);
        margin-bottom: 40px;
        position: relative;
      }

      .section-title::after {
        content: "";
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: var(--sunset-orange);
      }

      /* RSVP Section */
      .rsvp-section {
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px;
      }

      .rsvp-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 500px;
        margin: 0 auto;
      }

      .rsvp-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .rsvp-option {
        padding: 15px;
        border: 2px solid var(--sage-green);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
      }

      .rsvp-option:hover {
        background: var(--sage-green);
        color: white;
        transform: translateY(-2px);
      }

      .rsvp-option.selected {
        background: var(--forest-green);
        color: white;
        border-color: var(--forest-green);
      }

      .form-row {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .form-row input {
        flex: 1;
        min-width: 0; /* Ensures inputs can shrink equally */
      }

      .form-row input[type="text"],
      .form-row input[type="email"] {
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .form-row input[type="text"]:focus,
      .form-row input[type="email"]:focus {
        outline: none;
        border-color: var(--sage-green);
      }

      /* General input and textarea styling */
      input[type="text"],
      input[type="email"],
      textarea {
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      input[type="text"]:focus,
      input[type="email"]:focus,
      textarea:focus {
        outline: none;
        border-color: var(--sage-green);
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn {
        background: var(--forest-green);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: #244a35;
        transform: translateY(-2px);
      }

      .btn-small {
        background: var(--sage-green);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .btn-small:hover {
        background: #7a9968;
      }

      .attendees-list {
        margin-top: 40px;
        padding: 20px;
        background: var(--light-gray);
        border-radius: 10px;
      }

      .rsvp-summary {
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .rsvp-instructions {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        background: var(--cream);
        border-radius: 8px;
        border: 1px solid var(--sage-green);
      }

      .rsvp-instructions p {
        margin: 5px 0;
      }

      .rsvp-table-container {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin: 20px 0;
      }

      .rsvp-table {
        width: 100%;
        border-collapse: collapse;
      }

      .rsvp-table th {
        background: var(--forest-green);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: bold;
      }

      .rsvp-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e0e0e0;
      }

      .rsvp-table tbody tr {
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .rsvp-table tbody tr:hover {
        background-color: #f8f9fa;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.85em;
        font-weight: bold;
      }

      .status-badge.definitely {
        background: #d4edda;
        color: #155724;
      }

      .status-badge.maybe {
        background: #fff3cd;
        color: #856404;
      }

      .status-badge.not-for-me {
        background: #f8d7da;
        color: #721c24;
      }

      .status-badge.unsure {
        background: #e2e3e5;
        color: #383d41;
      }

      .add-new-rsvp {
        background: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-top: 20px;
      }

      .add-new-rsvp h4 {
        margin-bottom: 12px;
        color: var(--forest-green);
        font-size: 1.1em;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        position: relative;
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-content h3 {
        color: var(--forest-green);
        margin-bottom: 20px;
        text-align: center;
      }

      .edit-name {
        text-align: center;
        font-size: 1.2em;
        margin-bottom: 20px;
        color: var(--warm-brown);
      }

      .modal-content textarea {
        width: 100%;
        margin-bottom: 25px;
        box-sizing: border-box;
      }

      .modal-content .rsvp-options {
        margin-bottom: 20px;
      }

      .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 0;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        text-align: center;
      }

      .stat {
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9em;
      }

      .stat.definitely {
        background: #d4edda;
        color: #155724;
      }

      .stat.maybe {
        background: #fff3cd;
        color: #856404;
      }

      .stat.not-for-me {
        background: #f8d7da;
        color: #721c24;
      }

      .stat.unsure {
        background: #e2e3e5;
        color: #383d41;
      }

      .rsvp-list {
        margin-top: 20px;
      }

      .attendee {
        display: block;
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--sage-green);
      }

      .attendee[data-status="definitely"] {
        border-left-color: #28a745;
      }

      .attendee[data-status="maybe"] {
        border-left-color: #ffc107;
      }

      .attendee[data-status="not-for-me"] {
        border-left-color: #dc3545;
      }

      .attendee[data-status="unsure"] {
        border-left-color: #6c757d;
      }

      .attendee-name {
        font-weight: bold;
        color: var(--forest-green);
        display: block;
        margin-bottom: 5px;
      }

      .attendee-email {
        color: var(--warm-brown);
        font-size: 0.9em;
        display: block;
        margin-bottom: 5px;
      }

      .attendee-comment {
        color: var(--dark-text);
        font-style: italic;
        font-size: 0.9em;
        display: block;
      }

      /* Date Coordination */
      .date-section {
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 40px;
      }

      .calendly-placeholder {
        background: var(--light-gray);
        padding: 60px;
        border-radius: 10px;
        margin: 30px 0;
        border: 2px dashed var(--sage-green);
      }

      /* Campsite Voting */
      .campsite-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
      }

      .campsite-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .campsite-card:hover {
        transform: translateY(-5px);
      }

      .campsite-image {
        width: 100%;
        height: 200px;
        background: linear-gradient(
          135deg,
          var(--sage-green),
          var(--forest-green)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4em;
      }

      .campsite-info {
        padding: 20px;
      }

      .campsite-name {
        font-size: 1.5em;
        font-weight: bold;
        color: var(--forest-green);
        margin-bottom: 10px;
      }

      .campsite-features {
        list-style: none;
        margin: 15px 0;
      }

      .campsite-features li {
        padding: 5px 0;
        position: relative;
        padding-left: 25px;
      }

      .campsite-features li::before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: var(--sage-green);
        font-weight: bold;
      }

      .vote-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
      }

      .vote-count {
        font-size: 1.2em;
        color: var(--warm-brown);
      }

      /* Packing List */
      .packing-categories {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
      }

      .packing-category {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .category-title {
        font-size: 1.5em;
        color: var(--forest-green);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .packing-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .packing-item:last-child {
        border-bottom: none;
      }

      .item-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
      }

      .item-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .claimed-by {
        color: var(--sage-green);
        font-size: 0.9em;
        font-style: italic;
      }

      .add-item-form {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }

      .add-item-form input {
        flex: 1;
      }

      /* Additional Features */
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 30px;
        margin-top: 40px;
      }

      .info-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .info-icon {
        font-size: 3em;
        margin-bottom: 15px;
      }

      /* Loading States */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--sunset-orange);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .hero h1 {
          font-size: 2.5em;
        }

        .hero-quote {
          font-size: 1.1em;
        }

        .section-title {
          font-size: 2em;
        }

        .rsvp-options {
          grid-template-columns: 1fr;
        }
      }

      /* Connection Status */
      .connection-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--forest-green);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        display: none;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .connection-status.offline {
        background: var(--sunset-orange);
      }

      /* Availability System Styles */
      .availability-section {
        max-width: 1000px;
        margin: 0 auto;
      }

      .user-selector {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .user-input-section h3 {
        color: var(--forest-green);
        margin-bottom: 20px;
      }

      .user-form {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .user-form input {
        flex: 1;
        min-width: 200px;
      }

      .user-form select {
        flex: 1;
        min-width: 200px;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
        background: white;
      }

      .user-form select:focus {
        outline: none;
        border-color: var(--sage-green);
      }

      .current-user {
        background: var(--sage-green);
        color: white;
        padding: 15px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
      }

      .popular-weekends {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .popular-weekends h3 {
        color: var(--sunset-orange);
        margin-bottom: 20px;
      }

      .popular-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
      }

      .popular-weekend-card {
        background: linear-gradient(135deg, var(--sunset-orange), #ff8c65);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(255, 107, 53, 0.3);
        position: relative;
      }

      .popular-weekend-card .weekend-dates {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .popular-weekend-card .participant-count {
        font-size: 0.9em;
        opacity: 0.9;
      }

      /* Tooltip for popular weekend cards */
      .popular-weekend-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 0.9em;
        white-space: nowrap;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        pointer-events: none;
        margin-bottom: 5px;
      }

      .popular-weekend-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: rgba(0, 0, 0, 0.9);
      }

      .popular-weekend-card:hover .popular-weekend-tooltip {
        opacity: 1;
        visibility: visible;
      }

      .weekend-grid-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .weekend-grid-container h3 {
        color: var(--forest-green);
        margin-bottom: 15px;
      }

      .grid-instructions {
        color: #666;
        margin-bottom: 25px;
        font-style: italic;
      }

      .weekend-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .weekend-card {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        background: white;
      }

      .weekend-card:hover {
        border-color: var(--sage-green);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .weekend-card.available {
        background: var(--sage-green) !important;
        color: white !important;
        border-color: var(--sage-green) !important;
      }

      .weekend-card.available:hover {
        background: var(--forest-green) !important;
      }

      .weekend-card.heat-1 {
        background: linear-gradient(135deg, #ffebeb, #ffcccc);
        border-color: #ff9999;
      }

      .weekend-card.heat-2 {
        background: linear-gradient(135deg, #ffe0b3, #ffcc80);
        border-color: #ff9933;
      }

      .weekend-card.heat-3 {
        background: linear-gradient(135deg, #d4e6b3, #a8cc80);
        border-color: #7db33c;
      }

      .weekend-card.heat-4 {
        background: linear-gradient(135deg, #b3e6cc, #80cc99);
        border-color: #4d9966;
      }

      .weekend-card.heat-5 {
        background: linear-gradient(135deg, #80e6b3, #4dcc80);
        border-color: #26804d;
      }

      .weekend-dates {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 8px;
      }

      .weekend-participants {
        font-size: 0.9em;
        opacity: 0.8;
        margin-bottom: 10px;
      }

      .participant-preview {
        font-size: 0.8em;
        opacity: 0.7;
        min-height: 20px;
      }

      .participant-count-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--sunset-orange);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }

      /* Tooltip for showing all participants */
      .weekend-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 0.9em;
        white-space: nowrap;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        pointer-events: none;
        margin-bottom: 5px;
      }

      .weekend-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: rgba(0, 0, 0, 0.9);
      }

      .weekend-card:hover .weekend-tooltip {
        opacity: 1;
        visibility: visible;
      }

      .availability-summary {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .availability-summary h3 {
        color: var(--forest-green);
        margin-bottom: 20px;
      }

      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }

      .summary-card {
        background: linear-gradient(
          135deg,
          var(--sage-green),
          var(--forest-green)
        );
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(45, 90, 61, 0.3);
      }

      .summary-card h4 {
        margin-bottom: 10px;
        font-size: 1.1em;
      }

      .summary-card .summary-value {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .summary-card .summary-details {
        font-size: 0.9em;
        opacity: 0.9;
      }

      .participant-details {
        margin-top: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        font-size: 0.9em;
      }

      .participant-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .participant-tag {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .user-form {
          flex-direction: column;
        }

        .user-form input,
        .user-form select {
          min-width: 100%;
        }

        .weekend-grid {
          grid-template-columns: 1fr;
        }

        .summary-cards {
          grid-template-columns: 1fr;
        }

        .popular-list {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Hero Section -->
    <section class="hero">
      <div class="container">
        <h1>Camp Together üèïÔ∏è</h1>
        <p class="hero-quote">
          "The mountains are calling and I must go" - John Muir
        </p>
        <p style="font-size: 1.2em; margin-bottom: 30px">
          Disconnect to reconnect. Plan your perfect outdoor adventure!
        </p>

        <div class="activities">
          <div class="activity-badge">ü•æ Hiking</div>
          <div class="activity-badge">‚≠ê Stargazing</div>
          <div class="activity-badge">üî• Campfire Stories</div>
          <div class="activity-badge">üç´ S'mores</div>
          <div class="activity-badge">üç∫ Drinking</div>
          <div class="activity-badge">üì∏ Nature Photography</div>
          <div class="activity-badge">üéÆ Outdoor Games</div>
          <div class="activity-badge">
            ü¶å Wildlife Spotting (not guaranteed)
          </div>
        </div>
      </div>
    </section>

    <!-- RSVP Section -->
    <section class="section">
      <div class="container">
        <h2 class="section-title">RSVP Status üéâ</h2>

        <div class="rsvp-section">
          <div class="rsvp-instructions">
            <p><strong>Click on your row to update your RSVP status</strong></p>
            <p>Don't see your name? Add yourself below!</p>
          </div>

          <div class="rsvp-summary">
            <div class="summary-stats">
              <span class="stat definitely"
                >Definitely In: <strong id="definitelyCount">0</strong></span
              >
              <span class="stat maybe"
                >If dates work: <strong id="maybeCount">0</strong></span
              >
              <span class="stat not-for-me"
                >Not coming: <strong id="notForMeCount">0</strong></span
              >
              <span class="stat unsure"
                >Still deciding: <strong id="unsureCount">0</strong></span
              >
            </div>
          </div>

          <div class="rsvp-table-container">
            <table class="rsvp-table" id="rsvpTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="rsvpTableBody">
                <!-- RSVPs will be populated here -->
              </tbody>
            </table>
          </div>

          <div class="add-new-rsvp">
            <h4>Add New Person</h4>
            <form class="rsvp-form" id="rsvpForm">
              <div class="form-row">
                <input type="text" id="rsvpName" placeholder="Name" required />
                <input
                  type="email"
                  id="rsvpEmail"
                  placeholder="Email"
                  required
                />
                <button type="submit" class="btn">Add Person</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Edit Modal -->
        <div class="modal" id="editModal">
          <div class="modal-content">
            <h3>Update RSVP Status</h3>
            <form id="editForm">
              <input type="hidden" id="editEmail" />
              <div class="edit-name">
                <strong id="editingName"></strong>
              </div>

              <div class="rsvp-options">
                <div class="rsvp-option" data-status="definitely">
                  <h4>Definitely In! üôå</h4>
                  <p>Count me in!</p>
                </div>
                <div class="rsvp-option" data-status="maybe">
                  <h4>In if the dates work üìÖ</h4>
                  <p>I'll come if dates align</p>
                </div>
                <div class="rsvp-option" data-status="not-for-me">
                  <h4>Camping is not for me üè†</h4>
                  <p>I'll pass on this one</p>
                </div>
                <div class="rsvp-option" data-status="unsure">
                  <h4>Unsure/Still deciding ü§î</h4>
                  <p>Let me think about it</p>
                </div>
              </div>

              <textarea
                id="editComment"
                placeholder="Any comments, dietary restrictions, or special requests?"
                rows="3"
              ></textarea>

              <div class="modal-buttons">
                <button type="submit" class="btn">Update RSVP</button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="closeEditModal()"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- Universal User Identity Section -->
    <section class="section" style="background: var(--light-gray)">
      <div class="container">
        <h2 class="section-title">Who Are You? üë§</h2>

        <div class="user-selector">
          <div class="user-input-section">
            <p
              style="
                text-align: center;
                margin-bottom: 20px;
                font-size: 1.1em;
                color: var(--dark-text);
              "
            >
              Select your identity to participate in date coordination and other
              features
            </p>
            <div class="user-form">
              <select id="availabilityUserSelect" required>
                <option value="">Select your name from the RSVP list...</option>
              </select>
            </div>
            <div
              class="current-user"
              id="currentUserDisplay"
              style="display: none"
            >
              <span id="currentUserName"></span>
              <button
                type="button"
                class="btn-small"
                onclick="clearCurrentUser()"
              >
                Change User
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Date Coordination -->
    <section class="section">
      <div class="container">
        <h2 class="section-title">Find the Perfect Dates üìÖ</h2>

        <div class="availability-section">
          <p style="font-size: 1.2em; margin-bottom: 30px; text-align: center">
            Select your available weekends for camping between July 4th and
            Labor Day!
          </p>

          <div
            id="identityReminder"
            style="
              text-align: center;
              margin-bottom: 30px;
              padding: 15px;
              background: #fff3cd;
              border: 1px solid #ffeaa7;
              border-radius: 8px;
              color: #856404;
            "
          >
            <p>
              <strong
                >üí° Set your identity above to start selecting your available
                weekends!</strong
              >
            </p>
          </div>

          <!-- Popular Weekends Summary -->
          <div class="popular-weekends">
            <h3>üî• Most Popular Weekends</h3>
            <div id="popularWeekendsList" class="popular-list">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <!-- Weekend Grid -->
          <div class="weekend-grid-container">
            <h3>Select Your Available Weekends üóìÔ∏è</h3>
            <p class="grid-instructions">
              Click on weekends you're available for camping (Friday-Sunday)
            </p>
            <div id="weekendGrid" class="weekend-grid">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Campsite Voting -->
    <section class="section">
      <div class="container">
        <h2 class="section-title">Vote for Your Favorite Campsite üó≥Ô∏è</h2>

        <div style="text-align: center; margin-bottom: 30px">
          <p style="font-size: 1.1em; margin-bottom: 20px">
            Vote for your preferred campsite or propose a new option!
          </p>
          <button class="btn" onclick="openProposeCampsiteModal()">
            ‚ûï Propose New Campsite
          </button>
        </div>

        <div class="campsite-grid" id="campsiteGrid">
          <!-- Campsites will be dynamically loaded -->
        </div>

        <!-- Propose Campsite Modal -->
        <div class="modal" id="proposeCampsiteModal">
          <div class="modal-content">
            <h3>Propose a New Campsite üèïÔ∏è</h3>
            <form id="proposeCampsiteForm">
              <input
                type="text"
                id="campsiteName"
                placeholder="Campsite Name"
                required
                style="margin-bottom: 15px"
              />

              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; font-weight: bold"
                  >Emoji (optional):</label
                >
                <input
                  type="text"
                  id="campsiteEmoji"
                  placeholder="üèîÔ∏è"
                  maxlength="2"
                  style="width: 80px"
                />
              </div>

              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; font-weight: bold"
                  >Features (one per line):</label
                >
                <textarea
                  id="campsiteFeatures"
                  placeholder="Lake access&#10;Hot showers&#10;Fire pits&#10;Hiking trails"
                  rows="4"
                  required
                ></textarea>
              </div>

              <div style="display: flex; gap: 15px; margin-bottom: 15px">
                <div style="flex: 1">
                  <label
                    style="
                      display: block;
                      margin-bottom: 5px;
                      font-weight: bold;
                    "
                    >Distance:</label
                  >
                  <input
                    type="text"
                    id="campsiteDistance"
                    placeholder="45 miles"
                    required
                  />
                </div>
                <div style="flex: 1">
                  <label
                    style="
                      display: block;
                      margin-bottom: 5px;
                      font-weight: bold;
                    "
                    >Cost:</label
                  >
                  <input
                    type="text"
                    id="campsiteCost"
                    placeholder="$25/night"
                    required
                  />
                </div>
              </div>

              <div style="margin-bottom: 20px">
                <label
                  style="display: block; margin-bottom: 5px; font-weight: bold"
                  >Additional Info (optional):</label
                >
                <textarea
                  id="campsiteInfo"
                  placeholder="Any additional details, website links, or special notes..."
                  rows="3"
                ></textarea>
              </div>

              <div style="margin-bottom: 20px">
                <label
                  style="display: block; margin-bottom: 5px; font-weight: bold"
                  >Your Name:</label
                >
                <input
                  type="text"
                  id="campsiteProposer"
                  placeholder="Who's proposing this campsite?"
                  required
                />
              </div>

              <div class="modal-buttons">
                <button type="submit" class="btn">Propose Campsite</button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="closeProposeCampsiteModal()"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- Packing List -->
    <section class="section" style="background: var(--light-gray)">
      <div class="container">
        <h2 class="section-title">Shared Packing List üéí</h2>

        <div class="packing-categories" id="packingCategories">
          <!-- Categories will be dynamically loaded -->
        </div>
      </div>
    </section>

    <!-- Additional Info -->
    <section class="section">
      <div class="container">
        <h2 class="section-title">Essential Information üìç</h2>

        <div class="info-grid">
          <div class="info-card">
            <div class="info-icon">üå§Ô∏è</div>
            <h3>Weather Forecast</h3>
            <p>Sunny with highs of 75¬∞F</p>
            <p>Perfect camping weather!</p>
          </div>

          <div class="info-card">
            <div class="info-icon">üöó</div>
            <h3>Carpool Coordination</h3>
            <p>Share rides and save gas!</p>
            <button class="btn" style="margin-top: 15px">
              Sign Up for Carpool
            </button>
          </div>

          <div class="info-card">
            <div class="info-icon">üö®</div>
            <h3>Emergency Contacts</h3>
            <p>Park Ranger: (555) 123-4567</p>
            <p>Local Hospital: (555) 987-6543</p>
          </div>

          <div class="info-card">
            <div class="info-icon">üí°</div>
            <h3>First Timer Tips</h3>
            <p>New to camping? We've got you covered!</p>
            <ul style="text-align: left; margin-top: 10px">
              <li>Dress in layers</li>
              <li>Bring extra socks</li>
              <li>Don't forget bug spray!</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
      <span class="status-icon">üü¢</span>
      <span class="status-text">Connected</span>
    </div>

    <script>
      // Firebase Configuration - Replace with your config
      const firebaseConfig = {
        // Replace these placeholder values with your actual Firebase config
        // You can find these values in your Firebase project settings
        // For security, these should be loaded from environment variables in production
        apiKey: "YOUR_API_KEY_HERE",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID",
        measurementId: "YOUR_MEASUREMENT_ID",
      };

      // Initialize Firebase
      let db;
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();

        // Enable offline persistence
        db.enablePersistence().catch((err) => {
          if (err.code == "failed-precondition") {
            console.log(
              "Multiple tabs open, persistence can only be enabled in one tab at a time."
            );
          } else if (err.code == "unimplemented") {
            console.log(
              "The current browser does not support offline persistence"
            );
          }
        });
      } catch (error) {
        console.log("Firebase initialization error:", error);
        // Continue with local storage fallback
      }

      // Connection status monitoring
      let isOnline = true;
      function updateConnectionStatus(online) {
        isOnline = online;
        const statusEl = document.getElementById("connectionStatus");
        const statusIcon = statusEl.querySelector(".status-icon");
        const statusText = statusEl.querySelector(".status-text");

        if (online) {
          statusEl.classList.remove("offline");
          statusIcon.textContent = "üü¢";
          statusText.textContent = "Connected";
          statusEl.style.display = "none";
        } else {
          statusEl.classList.add("offline");
          statusIcon.textContent = "üî¥";
          statusText.textContent =
            "Offline - Changes will sync when reconnected";
          statusEl.style.display = "flex";
        }
      }

      // Monitor online/offline status
      window.addEventListener("online", () => updateConnectionStatus(true));
      window.addEventListener("offline", () => updateConnectionStatus(false));

      // RSVP System
      const rsvpForm = document.getElementById("rsvpForm");
      const editForm = document.getElementById("editForm");
      const editModal = document.getElementById("editModal");
      const rsvpOptions = document.querySelectorAll(".rsvp-option");
      let selectedStatus = null;
      let editingEmail = null;

      // Handle RSVP option selection in modal
      rsvpOptions.forEach((option) => {
        option.addEventListener("click", () => {
          rsvpOptions.forEach((opt) => opt.classList.remove("selected"));
          option.classList.add("selected");
          selectedStatus = option.dataset.status;
        });
      });

      // Add new person form
      rsvpForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("rsvpName").value.trim();
        const email = document
          .getElementById("rsvpEmail")
          .value.trim()
          .toLowerCase();

        if (!name || !email) {
          alert("Please enter both name and email");
          return;
        }

        const rsvpData = {
          name,
          email,
          status: "unsure", // Default status
          comment: "",
          timestamp: new Date(),
        };

        try {
          await saveOrUpdateRSVP(rsvpData);

          // Reset form
          rsvpForm.reset();

          alert("Person added! Click on their row to set their RSVP status.");
        } catch (error) {
          console.error("Error adding person:", error);
          alert("Error adding person. Please try again.");
        }
      });

      // Edit form submission
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!selectedStatus) {
          alert("Please select an RSVP status");
          return;
        }

        const email = document.getElementById("editEmail").value;
        const name = document.getElementById("editingName").textContent;
        const comment = document.getElementById("editComment").value;

        try {
          // Get existing RSVP data
          const rsvps = await getRSVPs();
          const existingRsvp = rsvps.find((r) => r.email === email);

          if (existingRsvp) {
            const updatedRsvp = {
              ...existingRsvp,
              status: selectedStatus,
              comment,
              timestamp: new Date(),
            };

            await saveOrUpdateRSVP(updatedRsvp);

            // Auto-populate user identity if not set
            if (!currentUser) {
              const userSelect = document.getElementById(
                "availabilityUserSelect"
              );
              const userOption = JSON.stringify({ name: name, email: email });

              // Check if this user exists in the dropdown
              const optionExists = Array.from(userSelect.options).some(
                (option) => option.value === userOption
              );

              if (optionExists) {
                userSelect.value = userOption;
                currentUser = { name: name, email: email };
                localStorage.setItem(
                  "campingUser",
                  JSON.stringify(currentUser)
                );
                updateUserDisplay();
                updateWeekendGridForUser();
              }
            }
          }

          closeEditModal();
          alert("RSVP updated successfully!");
        } catch (error) {
          console.error("Error updating RSVP:", error);
          alert("Error updating RSVP. Please try again.");
        }
      });

      // Save or update RSVP (handles both new and existing)
      async function saveOrUpdateRSVP(rsvpData) {
        try {
          if (db) {
            // Check if RSVP already exists
            const existingQuery = await db
              .collection("rsvps")
              .where("email", "==", rsvpData.email)
              .get();

            if (!existingQuery.empty) {
              // Update existing RSVP
              await existingQuery.docs[0].ref.update(rsvpData);
            } else {
              // Add new RSVP
              await db.collection("rsvps").add(rsvpData);
            }
          } else {
            // Fallback to local storage
            const rsvps = JSON.parse(
              localStorage.getItem("campingRsvps") || "[]"
            );
            const existingIndex = rsvps.findIndex(
              (r) => r.email === rsvpData.email
            );

            if (existingIndex >= 0) {
              rsvps[existingIndex] = rsvpData;
            } else {
              rsvps.push(rsvpData);
            }

            localStorage.setItem("campingRsvps", JSON.stringify(rsvps));
            updateRSVPDisplay();
          }
        } catch (error) {
          console.error("Error saving RSVP:", error);
          throw error;
        }
      }

      // Get RSVPs from storage
      async function getRSVPs() {
        try {
          if (db) {
            const snapshot = await db
              .collection("rsvps")
              .orderBy("timestamp", "desc")
              .get();
            const rsvps = [];
            snapshot.forEach((doc) => {
              rsvps.push({ id: doc.id, ...doc.data() });
            });
            return rsvps;
          } else {
            return JSON.parse(localStorage.getItem("campingRsvps") || "[]");
          }
        } catch (error) {
          console.error("Error getting RSVPs:", error);
          return JSON.parse(localStorage.getItem("campingRsvps") || "[]");
        }
      }

      // Real-time RSVP updates
      function listenToRSVPs() {
        if (db) {
          db.collection("rsvps")
            .orderBy("timestamp", "desc")
            .onSnapshot((snapshot) => {
              const rsvps = [];
              snapshot.forEach((doc) => {
                rsvps.push({ id: doc.id, ...doc.data() });
              });
              displayRSVPs(rsvps);
            });
        } else {
          // Fallback to local storage
          updateRSVPDisplay();
        }
      }

      function updateRSVPDisplay() {
        const rsvps = JSON.parse(localStorage.getItem("campingRsvps") || "[]");
        displayRSVPs(rsvps);
      }

      function displayRSVPs(rsvps) {
        updateSummaryStats(rsvps);
        displayRSVPTable(rsvps);
        // Update the availability user dropdown when RSVP list changes
        populateUserDropdown();
      }

      function updateSummaryStats(rsvps) {
        const definitelyCount = document.getElementById("definitelyCount");
        const maybeCount = document.getElementById("maybeCount");
        const notForMeCount = document.getElementById("notForMeCount");
        const unsureCount = document.getElementById("unsureCount");

        const definitely = rsvps.filter((r) => r.status === "definitely");
        const maybe = rsvps.filter((r) => r.status === "maybe");
        const notForMe = rsvps.filter((r) => r.status === "not-for-me");
        const unsure = rsvps.filter((r) => r.status === "unsure");

        definitelyCount.textContent = definitely.length;
        maybeCount.textContent = maybe.length;
        notForMeCount.textContent = notForMe.length;
        unsureCount.textContent = unsure.length;
      }

      function displayRSVPTable(rsvps) {
        const tbody = document.getElementById("rsvpTableBody");

        const statusText = {
          definitely: "Definitely In",
          maybe: "In if dates work",
          "not-for-me": "Not coming",
          unsure: "Still deciding",
        };

        tbody.innerHTML = rsvps
          .map((rsvp) => {
            return `
              <tr onclick="openEditModal('${rsvp.email}', '${rsvp.name}', '${
              rsvp.status
            }', '${(rsvp.comment || "").replace(/'/g, "&#39;")}')">
                <td><strong>${rsvp.name}</strong></td>
                <td>${rsvp.email}</td>
                <td>
                  <span class="status-badge ${rsvp.status}">
                    ${statusText[rsvp.status] || rsvp.status}
                  </span>
                </td>
                <td>${rsvp.comment || "<em>No notes</em>"}</td>
              </tr>
            `;
          })
          .join("");
      }

      // Modal functions
      function openEditModal(email, name, status, comment) {
        editingEmail = email;
        selectedStatus = status;

        document.getElementById("editEmail").value = email;
        document.getElementById("editingName").textContent = name;
        document.getElementById("editComment").value = comment || "";

        // Select current status
        rsvpOptions.forEach((opt) => opt.classList.remove("selected"));
        const currentOption = document.querySelector(
          `[data-status="${status}"]`
        );
        if (currentOption) {
          currentOption.classList.add("selected");
        }

        editModal.style.display = "block";
      }

      function closeEditModal() {
        editModal.style.display = "none";
        editingEmail = null;
        selectedStatus = null;
        rsvpOptions.forEach((opt) => opt.classList.remove("selected"));
        editForm.reset();
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target === editModal) {
          closeEditModal();
        }
      };

      // Legacy function name compatibility
      function displayAttendees(rsvps) {
        displayRSVPs(rsvps);
      }

      // Campsite Data
      const campsites = [
        {
          id: "pine-grove",
          name: "Pine Grove Campground",
          emoji: "üå≤",
          features: [
            "Lake access",
            "Hot showers",
            "Fire pits",
            "Hiking trails",
          ],
          distance: "45 miles",
          cost: "$25/night",
        },
        {
          id: "mountain-view",
          name: "Mountain View Site",
          emoji: "‚õ∞Ô∏è",
          features: [
            "Scenic views",
            "Rock climbing",
            "Stargazing deck",
            "Group shelter",
          ],
          distance: "72 miles",
          cost: "$30/night",
        },
        {
          id: "riverside",
          name: "Riverside Retreat",
          emoji: "üèûÔ∏è",
          features: ["River access", "Fishing", "Kayak rentals", "Beach area"],
          distance: "58 miles",
          cost: "$28/night",
        },
      ];

      // Display campsites
      function displayCampsites() {
        const campsiteGrid = document.getElementById("campsiteGrid");

        campsites.forEach((campsite) => {
          const card = document.createElement("div");
          card.className = "campsite-card";
          card.innerHTML = `
                    <div class="campsite-image">${campsite.emoji}</div>
                    <div class="campsite-info">
                        <h3 class="campsite-name">${campsite.name}</h3>
                        <ul class="campsite-features">
                            ${campsite.features
                              .map((f) => `<li>${f}</li>`)
                              .join("")}
                        </ul>
                        <p><strong>Distance:</strong> ${campsite.distance}</p>
                        <p><strong>Cost:</strong> ${campsite.cost}</p>
                        <div class="vote-section">
                            <span class="vote-count" id="votes-${
                              campsite.id
                            }">0 votes</span>
                            <button class="btn" onclick="voteCampsite('${
                              campsite.id
                            }')">Vote</button>
                        </div>
                    </div>
                `;
          campsiteGrid.appendChild(card);
        });

        // Listen to vote updates
        if (db) {
          campsites.forEach((campsite) => {
            db.collection("campsite_votes")
              .where("campsite_id", "==", campsite.id)
              .onSnapshot((snapshot) => {
                document.getElementById(
                  `votes-${campsite.id}`
                ).textContent = `${snapshot.size} votes`;
              });
          });
        }
      }

      // Vote for campsite
      async function voteCampsite(campsiteId) {
        const voterName = prompt("Enter your name to vote:");
        if (!voterName) return;

        try {
          if (db) {
            // Check if already voted
            const existingVote = await db
              .collection("campsite_votes")
              .where("voter_name", "==", voterName)
              .get();

            if (!existingVote.empty) {
              // Update existing vote
              await existingVote.docs[0].ref.update({
                campsite_id: campsiteId,
                timestamp: new Date(),
              });
            } else {
              // Add new vote
              await db.collection("campsite_votes").add({
                campsite_id: campsiteId,
                voter_name: voterName,
                timestamp: new Date(),
              });
            }
          } else {
            // Local storage fallback
            const votes = JSON.parse(
              localStorage.getItem("campsiteVotes") || "{}"
            );
            votes[voterName] = campsiteId;
            localStorage.setItem("campsiteVotes", JSON.stringify(votes));
            updateVoteDisplay();
          }

          alert("Vote recorded!");
        } catch (error) {
          console.error("Error voting:", error);
          alert("Error recording vote. Please try again.");
        }
      }

      function updateVoteDisplay() {
        const votes = JSON.parse(localStorage.getItem("campsiteVotes") || "{}");
        const voteCounts = {};

        Object.values(votes).forEach((campsiteId) => {
          voteCounts[campsiteId] = (voteCounts[campsiteId] || 0) + 1;
        });

        campsites.forEach((campsite) => {
          const count = voteCounts[campsite.id] || 0;
          document.getElementById(
            `votes-${campsite.id}`
          ).textContent = `${count} votes`;
        });
      }

      // Packing List Categories
      const packingCategories = [
        {
          name: "Camp Equipment",
          icon: "‚õ∫",
          items: [
            { name: "Tents (4-person)", quantity: 3, claimed_by: null },
            { name: "Sleeping bags", quantity: 10, claimed_by: null },
            { name: "Camping chairs", quantity: 10, claimed_by: null },
            { name: "Lanterns", quantity: 4, claimed_by: null },
            { name: "Cooler", quantity: 2, claimed_by: null },
            { name: "Camp stove", quantity: 2, claimed_by: null },
            { name: "First aid kit", quantity: 1, claimed_by: null },
          ],
        },
        {
          name: "Food & Drinks",
          icon: "üçî",
          items: [
            { name: "Hot dogs", quantity: 30, claimed_by: null },
            { name: "Burgers", quantity: 20, claimed_by: null },
            { name: "S'mores supplies", quantity: 1, claimed_by: null },
            { name: "Water bottles", quantity: 48, claimed_by: null },
            { name: "Snacks", quantity: 10, claimed_by: null },
            { name: "Coffee", quantity: 2, claimed_by: null },
          ],
        },
        {
          name: "Personal Items",
          icon: "üéí",
          items: [
            { name: "Bug spray", quantity: 5, claimed_by: null },
            { name: "Sunscreen", quantity: 5, claimed_by: null },
            { name: "Flashlights", quantity: 10, claimed_by: null },
            { name: "Portable chargers", quantity: 5, claimed_by: null },
            { name: "Toiletries", quantity: 1, claimed_by: null },
          ],
        },
      ];

      // Display packing lists
      function displayPackingLists() {
        const container = document.getElementById("packingCategories");

        packingCategories.forEach((category, catIndex) => {
          const categoryDiv = document.createElement("div");
          categoryDiv.className = "packing-category";
          categoryDiv.innerHTML = `
                    <h3 class="category-title">
                        <span>${category.icon}</span>
                        ${category.name}
                    </h3>
                    <div id="items-${catIndex}"></div>
                    <form class="add-item-form" onsubmit="addPackingItem(event, ${catIndex})">
                        <input type="text" placeholder="Add new item..." required>
                        <button type="submit" class="btn">Add</button>
                    </form>
                `;
          container.appendChild(categoryDiv);

          // Display items
          displayCategoryItems(catIndex);
        });

        // Listen to packing list updates
        if (db) {
          db.collection("packing_items").onSnapshot(() => {
            packingCategories.forEach((_, index) => {
              displayCategoryItems(index);
            });
          });
        }
      }

      async function displayCategoryItems(categoryIndex) {
        const category = packingCategories[categoryIndex];
        const container = document.getElementById(`items-${categoryIndex}`);

        let items = category.items;

        if (db) {
          try {
            const snapshot = await db
              .collection("packing_items")
              .where("category", "==", category.name)
              .get();

            const dbItems = [];
            snapshot.forEach((doc) => {
              dbItems.push({ id: doc.id, ...doc.data() });
            });

            if (dbItems.length > 0) {
              items = dbItems;
            }
          } catch (error) {
            console.error("Error fetching packing items:", error);
          }
        }

        container.innerHTML = items
          .map(
            (item) => `
                <div class="packing-item">
                    <div class="item-info">
                        <input type="checkbox" class="item-checkbox" 
                               ${item.claimed_by ? "checked" : ""}
                               onchange="toggleItemClaim('${item.name}', '${
              category.name
            }', this.checked)">
                        <span>${item.name} ${
              item.quantity > 1 ? `(${item.quantity})` : ""
            }</span>
                        ${
                          item.claimed_by
                            ? `<span class="claimed-by">- ${item.claimed_by}</span>`
                            : ""
                        }
                    </div>
                </div>
            `
          )
          .join("");
      }

      async function toggleItemClaim(itemName, categoryName, claimed) {
        const claimerName = claimed ? prompt("Enter your name:") : null;

        if (claimed && !claimerName) {
          event.target.checked = false;
          return;
        }

        try {
          if (db) {
            const itemQuery = await db
              .collection("packing_items")
              .where("name", "==", itemName)
              .where("category", "==", categoryName)
              .get();

            if (!itemQuery.empty) {
              await itemQuery.docs[0].ref.update({
                claimed_by: claimerName,
              });
            } else {
              // Add new item if not exists
              await db.collection("packing_items").add({
                name: itemName,
                category: categoryName,
                quantity: 1,
                claimed_by: claimerName,
                timestamp: new Date(),
              });
            }
          } else {
            // Local storage fallback
            const claims = JSON.parse(
              localStorage.getItem("packingClaims") || "{}"
            );
            const key = `${categoryName}-${itemName}`;

            if (claimed) {
              claims[key] = claimerName;
            } else {
              delete claims[key];
            }

            localStorage.setItem("packingClaims", JSON.stringify(claims));
            displayCategoryItems(
              packingCategories.findIndex((c) => c.name === categoryName)
            );
          }
        } catch (error) {
          console.error("Error updating item:", error);
          alert("Error updating item. Please try again.");
          event.target.checked = !claimed;
        }
      }

      async function addPackingItem(event, categoryIndex) {
        event.preventDefault();

        const form = event.target;
        const input = form.querySelector("input");
        const itemName = input.value.trim();

        if (!itemName) return;

        const category = packingCategories[categoryIndex];

        try {
          if (db) {
            await db.collection("packing_items").add({
              name: itemName,
              category: category.name,
              quantity: 1,
              claimed_by: null,
              timestamp: new Date(),
            });
          } else {
            // Local storage fallback
            category.items.push({
              name: itemName,
              quantity: 1,
              claimed_by: null,
            });
            displayCategoryItems(categoryIndex);
          }

          input.value = "";
        } catch (error) {
          console.error("Error adding item:", error);
          alert("Error adding item. Please try again.");
        }
      }

      // Initialize everything
      document.addEventListener("DOMContentLoaded", () => {
        listenToRSVPs();
        displayCampsites();
        displayPackingLists();
        initializeAvailabilitySystem();

        // Check initial connection status
        updateConnectionStatus(navigator.onLine);

        // Add smooth scroll behavior
        document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
          anchor.addEventListener("click", function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute("href"));
            if (target) {
              target.scrollIntoView({ behavior: "smooth" });
            }
          });
        });
      });

      // AVAILABILITY SYSTEM
      let currentUser = null;
      let allAvailabilities = [];

      // Generate weekend dates from July 4th to Labor Day 2024
      function generateWeekendDates() {
        const weekends = [];
        const year = new Date().getFullYear();

        // Start from July 4th weekend (find the Friday before or on July 4th)
        let july4th = new Date(year, 6, 4); // July 4th
        let startFriday = new Date(july4th);

        // Find the Friday of July 4th week
        while (startFriday.getDay() !== 5) {
          // 5 = Friday
          startFriday.setDate(startFriday.getDate() - 1);
        }

        // Labor Day is first Monday in September
        let laborDay = new Date(year, 8, 1); // September 1st
        while (laborDay.getDay() !== 1) {
          // 1 = Monday
          laborDay.setDate(laborDay.getDate() + 1);
        }

        // Generate all weekends from start Friday to Labor Day
        let currentFriday = new Date(startFriday);

        while (currentFriday <= laborDay) {
          const friday = new Date(currentFriday);
          const saturday = new Date(currentFriday);
          saturday.setDate(saturday.getDate() + 1);
          const sunday = new Date(currentFriday);
          sunday.setDate(sunday.getDate() + 2);

          weekends.push({
            id: `weekend-${friday.getTime()}`,
            friday,
            saturday,
            sunday,
            startDate: friday,
            endDate: sunday,
          });

          // Move to next Friday
          currentFriday.setDate(currentFriday.getDate() + 7);
        }

        return weekends;
      }

      // Initialize availability system
      function initializeAvailabilitySystem() {
        setupUserManagement();
        generateWeekendGrid();
        listenToAvailabilities();
        updateAvailabilityDisplay();
        // Ensure user display is updated on initial load
        updateUserDisplay();
      }

      // User management
      function setupUserManagement() {
        const userSelect = document.getElementById("availabilityUserSelect");

        // Check if user is already stored
        const storedUser = localStorage.getItem("campingUser");
        if (storedUser) {
          currentUser = JSON.parse(storedUser);
          // Set the dropdown to match the stored user
          userSelect.value = JSON.stringify(currentUser);
          updateUserDisplay();
        }

        // Auto-update when dropdown changes
        userSelect.addEventListener("change", function () {
          const selectedValue = this.value;

          if (selectedValue) {
            currentUser = JSON.parse(selectedValue);
            localStorage.setItem("campingUser", JSON.stringify(currentUser));
          } else {
            currentUser = null;
            localStorage.removeItem("campingUser");
          }

          updateUserDisplay();
          updateWeekendGridForUser();
        });

        // Populate user dropdown when RSVPs change
        populateUserDropdown();
      }

      // Update user display
      function updateUserDisplay() {
        const userSelect = document.getElementById("availabilityUserSelect");
        const currentUserDisplay =
          document.getElementById("currentUserDisplay");
        const currentUserName = document.getElementById("currentUserName");
        const identityReminder = document.getElementById("identityReminder");

        if (currentUser) {
          userSelect.style.display = "none";
          currentUserDisplay.style.display = "flex";
          currentUserName.textContent = `Logged in as: ${currentUser.name}`;
          if (identityReminder) {
            identityReminder.style.display = "none";
          }
        } else {
          userSelect.style.display = "block";
          currentUserDisplay.style.display = "none";
          if (identityReminder) {
            identityReminder.style.display = "block";
          }
        }
      }

      // Clear current user
      function clearCurrentUser() {
        currentUser = null;
        localStorage.removeItem("campingUser");
        const userSelect = document.getElementById("availabilityUserSelect");
        userSelect.value = "";
        updateUserDisplay();
        updateWeekendGridForUser();
      }

      async function populateUserDropdown() {
        const select = document.getElementById("availabilityUserSelect");
        const rsvps = await getRSVPs();
        const currentValue = select.value;

        // Clear existing options except the first one
        select.innerHTML =
          '<option value="">Select your name from the RSVP list...</option>';

        // Add each RSVP person as an option
        rsvps.forEach((rsvp) => {
          const option = document.createElement("option");
          option.value = JSON.stringify({ name: rsvp.name, email: rsvp.email });
          option.textContent = rsvp.name;
          select.appendChild(option);
        });

        // Restore the previous selection if it still exists
        if (
          currentValue &&
          rsvps.some(
            (rsvp) =>
              JSON.stringify({ name: rsvp.name, email: rsvp.email }) ===
              currentValue
          )
        ) {
          select.value = currentValue;
        } else if (currentUser) {
          // Check if current user still exists in the new list
          const currentUserOption = JSON.stringify(currentUser);
          const optionExists = rsvps.some(
            (rsvp) =>
              JSON.stringify({ name: rsvp.name, email: rsvp.email }) ===
              currentUserOption
          );

          if (optionExists) {
            select.value = currentUserOption;
          } else {
            // Current user no longer exists, clear it
            currentUser = null;
            localStorage.removeItem("campingUser");
          }
        }

        // Update display after populating
        updateUserDisplay();
      }

      function setCurrentUser() {
        // This function is no longer needed
      }

      function changeCurrentUser() {
        // This function is no longer needed
      }

      function showCurrentUser() {
        // This function is no longer needed
      }

      // Generate weekend grid
      function generateWeekendGrid() {
        const weekends = generateWeekendDates();
        const grid = document.getElementById("weekendGrid");

        grid.innerHTML = weekends
          .map((weekend) => {
            const fridayStr = weekend.friday.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            });
            const sundayStr = weekend.sunday.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            });

            return `
            <div class="weekend-card" data-weekend-id="${weekend.id}" onclick="toggleWeekendAvailability('${weekend.id}')">
              <div class="weekend-dates">${fridayStr} - ${sundayStr}</div>
              <div class="weekend-participants" id="participants-${weekend.id}">0 available</div>
              <div class="participant-preview" id="preview-${weekend.id}"></div>
              <div class="participant-count-badge" id="badge-${weekend.id}" style="display: none;">0</div>
              <div class="weekend-tooltip" id="tooltip-${weekend.id}">No one available yet</div>
            </div>
          `;
          })
          .join("");
      }

      // Toggle weekend availability
      async function toggleWeekendAvailability(weekendId) {
        if (!currentUser) {
          alert("Please set your identity first!");
          return;
        }

        try {
          // Get current user's availabilities
          const userAvailabilities = await getUserAvailabilities(
            currentUser.email
          );
          const isCurrentlyAvailable = userAvailabilities.includes(weekendId);

          let updatedAvailabilities;
          if (isCurrentlyAvailable) {
            // Remove availability
            updatedAvailabilities = userAvailabilities.filter(
              (id) => id !== weekendId
            );
          } else {
            // Add availability
            updatedAvailabilities = [...userAvailabilities, weekendId];
          }

          // Save to database
          await saveUserAvailabilities(currentUser, updatedAvailabilities);

          // Update UI
          updateWeekendCardDisplay(weekendId, !isCurrentlyAvailable);
        } catch (error) {
          console.error("Error toggling availability:", error);
          alert("Error updating availability. Please try again.");
        }
      }

      // Get user's current availabilities
      async function getUserAvailabilities(email) {
        try {
          if (db) {
            const snapshot = await db
              .collection("weekend_availabilities")
              .where("email", "==", email)
              .get();

            if (!snapshot.empty) {
              return snapshot.docs[0].data().availableWeekends || [];
            }
          } else {
            // Local storage fallback
            const stored = localStorage.getItem(`availabilities_${email}`);
            return stored ? JSON.parse(stored) : [];
          }
          return [];
        } catch (error) {
          console.error("Error getting availabilities:", error);
          return [];
        }
      }

      // Save user availabilities
      async function saveUserAvailabilities(user, availabilities) {
        try {
          const data = {
            name: user.name,
            email: user.email,
            availableWeekends: availabilities,
            timestamp: new Date(),
          };

          if (db) {
            const existingQuery = await db
              .collection("weekend_availabilities")
              .where("email", "==", user.email)
              .get();

            if (!existingQuery.empty) {
              await existingQuery.docs[0].ref.update(data);
            } else {
              await db.collection("weekend_availabilities").add(data);
            }
          } else {
            // Local storage fallback
            localStorage.setItem(
              `availabilities_${user.email}`,
              JSON.stringify(availabilities)
            );
            const allUsers = JSON.parse(
              localStorage.getItem("allAvailabilityUsers") || "[]"
            );
            const existingUserIndex = allUsers.findIndex(
              (u) => u.email === user.email
            );

            if (existingUserIndex >= 0) {
              allUsers[existingUserIndex] = data;
            } else {
              allUsers.push(data);
            }

            localStorage.setItem(
              "allAvailabilityUsers",
              JSON.stringify(allUsers)
            );
            updateAvailabilityDisplay();
          }
        } catch (error) {
          console.error("Error saving availabilities:", error);
          throw error;
        }
      }

      // Listen to real-time availability updates
      function listenToAvailabilities() {
        if (db) {
          db.collection("weekend_availabilities").onSnapshot((snapshot) => {
            allAvailabilities = [];
            snapshot.forEach((doc) => {
              allAvailabilities.push({ id: doc.id, ...doc.data() });
            });
            updateAvailabilityDisplay();
          });
        } else {
          // For local storage, update periodically
          updateAvailabilityDisplay();
        }
      }

      // Update weekend card display for current user
      async function updateWeekendCardDisplay(weekendId, isAvailable) {
        const card = document.querySelector(`[data-weekend-id="${weekendId}"]`);
        if (!card) return;

        if (isAvailable) {
          card.classList.add("available");
        } else {
          card.classList.remove("available");
        }
      }

      // Update weekend grid for current user
      async function updateWeekendGridForUser() {
        if (!currentUser) {
          // Clear all user-specific styling
          document.querySelectorAll(".weekend-card").forEach((card) => {
            card.classList.remove("available");
          });
          return;
        }

        const userAvailabilities = await getUserAvailabilities(
          currentUser.email
        );

        document.querySelectorAll(".weekend-card").forEach((card) => {
          const weekendId = card.dataset.weekendId;
          if (userAvailabilities.includes(weekendId)) {
            card.classList.add("available");
          } else {
            card.classList.remove("available");
          }
        });
      }

      // Update all availability displays (heat map, counts, summaries)
      async function updateAvailabilityDisplay() {
        // Get all availabilities
        let availabilities = allAvailabilities;

        if (!db) {
          // Local storage fallback
          availabilities = JSON.parse(
            localStorage.getItem("allAvailabilityUsers") || "[]"
          );
        }

        const weekendCounts = {};
        const weekendParticipants = {};

        // Count participants for each weekend
        availabilities.forEach((user) => {
          (user.availableWeekends || []).forEach((weekendId) => {
            weekendCounts[weekendId] = (weekendCounts[weekendId] || 0) + 1;
            if (!weekendParticipants[weekendId]) {
              weekendParticipants[weekendId] = [];
            }
            weekendParticipants[weekendId].push(user.name);
          });
        });

        // Update weekend cards with heat map and participant info
        document.querySelectorAll(".weekend-card").forEach((card) => {
          const weekendId = card.dataset.weekendId;
          const count = weekendCounts[weekendId] || 0;
          const participants = weekendParticipants[weekendId] || [];

          // Update participant count
          const participantsEl = card.querySelector(".weekend-participants");
          participantsEl.textContent = `${count} available`;

          // Update participant preview
          const previewEl = card.querySelector(".participant-preview");
          if (participants.length > 0) {
            const preview =
              participants.length <= 2
                ? participants.join(", ")
                : `${participants.slice(0, 2).join(", ")} +${
                    participants.length - 2
                  } more`;
            previewEl.textContent = preview;
          } else {
            previewEl.textContent = "No one yet";
          }

          // Update tooltip with all participants
          const tooltipEl = card.querySelector(".weekend-tooltip");
          if (participants.length > 0) {
            tooltipEl.textContent = `Available: ${participants.join(", ")}`;
          } else {
            tooltipEl.textContent = "No one available yet";
          }

          // Update count badge
          const badgeEl = card.querySelector(".participant-count-badge");
          if (count > 0) {
            badgeEl.textContent = count;
            badgeEl.style.display = "flex";
          } else {
            badgeEl.style.display = "none";
          }

          // Apply heat map styling
          card.classList.remove(
            "heat-1",
            "heat-2",
            "heat-3",
            "heat-4",
            "heat-5"
          );
          if (count > 0 && !card.classList.contains("available")) {
            const heatLevel = Math.min(5, Math.max(1, count));
            card.classList.add(`heat-${heatLevel}`);
          }
        });

        // Update popular weekends
        updatePopularWeekends(weekendCounts, weekendParticipants);

        // Update current user's selections
        if (currentUser) {
          updateWeekendGridForUser();
        }
      }

      // Update popular weekends section
      function updatePopularWeekends(weekendCounts, weekendParticipants) {
        const popularList = document.getElementById("popularWeekendsList");

        // Get top 3 most popular weekends
        const sortedWeekends = Object.entries(weekendCounts)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 3);

        if (sortedWeekends.length === 0) {
          popularList.innerHTML =
            '<p style="text-align: center; color: #666;">No availabilities submitted yet</p>';
          return;
        }

        const weekends = generateWeekendDates();

        popularList.innerHTML = sortedWeekends
          .map(([weekendId, count]) => {
            const weekend = weekends.find((w) => w.id === weekendId);
            if (!weekend) return "";

            const fridayStr = weekend.friday.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            });
            const sundayStr = weekend.sunday.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            });

            const participants = weekendParticipants[weekendId] || [];
            const tooltipText =
              participants.length > 0
                ? `Available: ${participants.join(", ")}`
                : "No one available yet";

            return `
            <div class="popular-weekend-card">
              <div class="weekend-dates">${fridayStr} - ${sundayStr}</div>
              <div class="participant-count">${count} people available</div>
              <div class="popular-weekend-tooltip">${tooltipText}</div>
            </div>
          `;
          })
          .join("");
      }

      // Update availability summary
      function updateAvailabilitySummary(availabilities, weekendCounts) {
        const summaryEl = document.getElementById("availabilitySummary");

        const totalParticipants = availabilities.length;
        const totalWeekends = Object.keys(weekendCounts).length;
        const avgAvailability =
          totalParticipants > 0
            ? (
                Object.values(weekendCounts).reduce((a, b) => a + b, 0) /
                  Object.values(weekendCounts).length || 0
              ).toFixed(1)
            : 0;

        // Find best weekend
        const bestWeekend = Object.entries(weekendCounts).sort(
          ([, a], [, b]) => b - a
        )[0];

        const weekends = generateWeekendDates();
        let bestWeekendInfo = "None yet";
        if (bestWeekend) {
          const weekend = weekends.find((w) => w.id === bestWeekend[0]);
          if (weekend) {
            const fridayStr = weekend.friday.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            });
            const sundayStr = weekend.sunday.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            });
            bestWeekendInfo = `${fridayStr} - ${sundayStr}`;
          }
        }

        summaryEl.innerHTML = `
          <div class="summary-card">
            <h4>Total Participants</h4>
            <div class="summary-value">${totalParticipants}</div>
            <div class="summary-details">People who submitted availability</div>
          </div>
          
          <div class="summary-card">
            <h4>Weekends with Interest</h4>
            <div class="summary-value">${totalWeekends}</div>
            <div class="summary-details">Out of ${
              generateWeekendDates().length
            } total weekends</div>
          </div>
          
          <div class="summary-card">
            <h4>Best Weekend</h4>
            <div class="summary-value">${bestWeekend ? bestWeekend[1] : 0}</div>
            <div class="summary-details">People available: ${bestWeekendInfo}</div>
          </div>
          
          <div class="summary-card">
            <h4>Average Interest</h4>
            <div class="summary-value">${avgAvailability}</div>
            <div class="summary-details">People per weekend</div>
          </div>
        `;
      }

      // FIREBASE-CONNECTED CAMPSITE SYSTEM

      // Default campsite data (fallback when no Firebase data)
      const defaultCampsites = [
        {
          id: "pine-grove",
          name: "Pine Grove Campground",
          emoji: "üå≤",
          features: [
            "Lake access",
            "Hot showers",
            "Fire pits",
            "Hiking trails",
          ],
          distance: "45 miles",
          cost: "$25/night",
          proposedBy: "System",
          timestamp: new Date(),
        },
        {
          id: "mountain-view",
          name: "Mountain View Site",
          emoji: "‚õ∞Ô∏è",
          features: [
            "Scenic views",
            "Rock climbing",
            "Stargazing deck",
            "Group shelter",
          ],
          distance: "72 miles",
          cost: "$30/night",
          proposedBy: "System",
          timestamp: new Date(),
        },
        {
          id: "riverside",
          name: "Riverside Retreat",
          emoji: "üèûÔ∏è",
          features: ["River access", "Fishing", "Kayak rentals", "Beach area"],
          distance: "58 miles",
          cost: "$28/night",
          proposedBy: "System",
          timestamp: new Date(),
        },
      ];

      // Get all campsites from Firebase or local storage
      async function getCampsites() {
        try {
          if (db) {
            const snapshot = await db
              .collection("campsites")
              .orderBy("timestamp", "desc")
              .get();

            const campsites = [];
            snapshot.forEach((doc) => {
              campsites.push({ id: doc.id, ...doc.data() });
            });

            // If no campsites in Firebase, add default ones
            if (campsites.length === 0) {
              console.log("No campsites found, adding defaults...");
              await Promise.all(
                defaultCampsites.map((campsite) =>
                  db.collection("campsites").add(campsite)
                )
              );
              return defaultCampsites;
            }

            return campsites;
          } else {
            // Local storage fallback
            const stored = localStorage.getItem("campsites");
            return stored ? JSON.parse(stored) : defaultCampsites;
          }
        } catch (error) {
          console.error("Error getting campsites:", error);
          return defaultCampsites;
        }
      }

      // Load and display campsites
      async function loadAndDisplayCampsites() {
        try {
          const campsites = await getCampsites();
          displayCampsitesList(campsites);

          // Listen for real-time updates
          if (db) {
            db.collection("campsites")
              .orderBy("timestamp", "desc")
              .onSnapshot((snapshot) => {
                const updatedCampsites = [];
                snapshot.forEach((doc) => {
                  updatedCampsites.push({ id: doc.id, ...doc.data() });
                });
                displayCampsitesList(updatedCampsites);
              });
          }
        } catch (error) {
          console.error("Error loading campsites:", error);
          displayCampsitesList(defaultCampsites);
        }
      }

      // Display campsites list
      function displayCampsitesList(campsites) {
        const campsiteGrid = document.getElementById("campsiteGrid");

        if (!campsiteGrid) {
          console.error("Campsite grid element not found");
          return;
        }

        campsiteGrid.innerHTML = "";

        campsites.forEach((campsite) => {
          const card = document.createElement("div");
          card.className = "campsite-card";

          const featuresHTML = Array.isArray(campsite.features)
            ? campsite.features.map((f) => `<li>${f}</li>`).join("")
            : (campsite.features || "")
                .split("\n")
                .map((f) => `<li>${f.trim()}</li>`)
                .join("");

          const proposedByText =
            campsite.proposedBy && campsite.proposedBy !== "System"
              ? `<p style="font-size: 0.9em; color: #666; font-style: italic;">Proposed by: ${campsite.proposedBy}</p>`
              : "";

          const additionalInfo = campsite.additionalInfo
            ? `<p style="margin-top: 10px; font-size: 0.9em; color: #555;">${campsite.additionalInfo}</p>`
            : "";

          card.innerHTML = `
            <div class="campsite-image">${campsite.emoji || "üèïÔ∏è"}</div>
            <div class="campsite-info">
              <h3 class="campsite-name">${campsite.name}</h3>
              <ul class="campsite-features">
                ${featuresHTML}
              </ul>
              <p><strong>Distance:</strong> ${campsite.distance}</p>
              <p><strong>Cost:</strong> ${campsite.cost}</p>
              ${additionalInfo}
              ${proposedByText}
              <div class="vote-section">
                <span class="vote-count" id="votes-${
                  campsite.id
                }">0 votes</span>
                <button class="btn" onclick="voteCampsiteEnhanced('${
                  campsite.id
                }')">Vote</button>
              </div>
            </div>
          `;

          campsiteGrid.appendChild(card);

          // Load vote count for this campsite
          loadCampsiteVotes(campsite.id);
        });
      }

      // Load vote count for a specific campsite
      async function loadCampsiteVotes(campsiteId) {
        try {
          if (db) {
            db.collection("campsite_votes")
              .where("campsite_id", "==", campsiteId)
              .onSnapshot((snapshot) => {
                const voteElement = document.getElementById(
                  `votes-${campsiteId}`
                );
                if (voteElement) {
                  voteElement.textContent = `${snapshot.size} votes`;
                }
              });
          } else {
            // Local storage fallback
            const votes = JSON.parse(
              localStorage.getItem("campsiteVotes") || "{}"
            );
            const voteCount = Object.values(votes).filter(
              (id) => id === campsiteId
            ).length;
            const voteElement = document.getElementById(`votes-${campsiteId}`);
            if (voteElement) {
              voteElement.textContent = `${voteCount} votes`;
            }
          }
        } catch (error) {
          console.error("Error loading votes for campsite:", campsiteId, error);
        }
      }

      // Modal functions
      function openProposeCampsiteModal() {
        const modal = document.getElementById("proposeCampsiteModal");
        if (modal) {
          modal.style.display = "block";
        }
      }

      function closeProposeCampsiteModal() {
        const modal = document.getElementById("proposeCampsiteModal");
        if (modal) {
          modal.style.display = "none";
          // Reset form
          const form = document.getElementById("proposeCampsiteForm");
          if (form) {
            form.reset();
          }
        }
      }

      // Handle propose campsite form submission
      function initializeProposeCampsiteForm() {
        const form = document.getElementById("proposeCampsiteForm");

        if (!form) {
          console.error("Propose campsite form not found");
          return;
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const name = document.getElementById("campsiteName").value.trim();
          const emoji =
            document.getElementById("campsiteEmoji").value.trim() || "üèïÔ∏è";
          const featuresText = document
            .getElementById("campsiteFeatures")
            .value.trim();
          const distance = document
            .getElementById("campsiteDistance")
            .value.trim();
          const cost = document.getElementById("campsiteCost").value.trim();
          const additionalInfo = document
            .getElementById("campsiteInfo")
            .value.trim();
          const proposedBy = document
            .getElementById("campsiteProposer")
            .value.trim();

          if (!name || !featuresText || !distance || !cost || !proposedBy) {
            alert("Please fill in all required fields");
            return;
          }

          const features = featuresText
            .split("\n")
            .map((f) => f.trim())
            .filter((f) => f);

          const campsiteData = {
            name,
            emoji,
            features,
            distance,
            cost,
            additionalInfo,
            proposedBy,
            timestamp: new Date(),
          };

          try {
            await saveCampsite(campsiteData);
            closeProposeCampsiteModal();
            alert(
              "Campsite proposed successfully! It will appear in the list."
            );
          } catch (error) {
            console.error("Error proposing campsite:", error);
            alert("Error proposing campsite. Please try again.");
          }
        });
      }

      // Save campsite to Firebase or local storage
      async function saveCampsite(campsiteData) {
        try {
          if (db) {
            await db.collection("campsites").add(campsiteData);
          } else {
            // Local storage fallback
            const campsites = JSON.parse(
              localStorage.getItem("campsites") || "[]"
            );
            campsiteData.id = `campsite-${Date.now()}`;
            campsites.push(campsiteData);
            localStorage.setItem("campsites", JSON.stringify(campsites));

            // Trigger display update
            loadAndDisplayCampsites();
          }
        } catch (error) {
          console.error("Error saving campsite:", error);
          throw error;
        }
      }

      // Enhanced vote function
      async function voteCampsiteEnhanced(campsiteId) {
        const voterName = prompt("Enter your name to vote:");
        if (!voterName) return;

        try {
          if (db) {
            // Check if already voted
            const existingVote = await db
              .collection("campsite_votes")
              .where("voter_name", "==", voterName)
              .get();

            if (!existingVote.empty) {
              // Update existing vote
              await existingVote.docs[0].ref.update({
                campsite_id: campsiteId,
                timestamp: new Date(),
              });
              alert("Your vote has been updated!");
            } else {
              // Add new vote
              await db.collection("campsite_votes").add({
                campsite_id: campsiteId,
                voter_name: voterName,
                timestamp: new Date(),
              });
              alert("Vote recorded!");
            }
          } else {
            // Local storage fallback
            const votes = JSON.parse(
              localStorage.getItem("campsiteVotes") || "{}"
            );
            votes[voterName] = campsiteId;
            localStorage.setItem("campsiteVotes", JSON.stringify(votes));
            loadAndDisplayCampsites();
            alert("Vote recorded!");
          }
        } catch (error) {
          console.error("Error voting:", error);
          alert("Error recording vote. Please try again.");
        }
      }

      // Initialize campsite system
      function initializeCampsiteSystem() {
        // Load and display campsites
        loadAndDisplayCampsites();

        // Set up form handler
        initializeProposeCampsiteForm();

        // Close modal when clicking outside
        window.addEventListener("click", function (event) {
          const modal = document.getElementById("proposeCampsiteModal");
          if (event.target === modal) {
            closeProposeCampsiteModal();
          }
        });
      }

      // Call campsite initialization
      document.addEventListener("DOMContentLoaded", () => {
        initializeCampsiteSystem();
      });
    </script>
  </body>
</html>
